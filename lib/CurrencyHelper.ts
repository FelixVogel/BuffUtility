module CurrencyHelper {

    export interface Data {
        'date': string,
        'rates': {
            [name: string]: [number, number]
        },
        'symbols': {
            [name: string]: string
        }
    }

    const raw = `{"date":"2022-09-13","rates":{"AED":[0.5305713918097558,2],"AFN":[12.743073381285944,2],"ALL":[16.752356986050085,2],"AMD":[58.560580885725486,2],"ANG":[0.26038877036336633,2],"AOA":[61.87759916069396,2],"ARS":[20.55034489715922,2],"AUD":[0.2098485946283217,2],"AWG":[0.2600143142544526,2],"AZN":[0.2458074950781392,2],"BAM":[0.2787623399175199,2],"BBD":[0.29171968968018624,2],"BDT":[13.72942895870852,2],"BGN":[0.278723725912377,2],"BHD":[0.054451731709892266,3],"BIF":[298.23723034137487,2],"BMD":[0.14445242847183007,2],"BND":[0.201757036974976,2],"BOB":[0.9983676677383122,2],"BRL":[0.7357247513920634,2],"BSD":[0.14447736371500358,2],"BTC":[0.0000064665349800852895,7],"BTN":[11.49057027471086,2],"BWP":[1.85703114725344,2],"BYN":[0.36474931745115086,2],"BYR":[2831.2666177365954,2],"BZD":[0.2912208423296128,2],"CAD":[0.18745004936465715,2],"CDF":[294.3939238369383,2],"CHF":[0.13741100077384746,2],"CLF":[0.004702929349621889,4],"CLP":[129.76873502371484,2],"COP":[629.9929354893911,2],"CRC":[93.17650874963434,2],"CUC":[0.14445242847183007,2],"CUP":[3.8279880008760103,2],"CVE":[15.715877152748599,2],"CZK":[3.495916960795671,2],"DJF":[25.720012983424905,2],"DKK":[1.0596057752302983,2],"DOP":[7.688316157225399,2],"DZD":[20.307257765867757,2],"EGP":[2.79700247029892,2],"ERN":[2.1667857146419323,2],"ETB":[7.628855148892612,2],"EUR":[0.14248710384844843,2],"FJD":[0.3203808281321978,2],"FKP":[0.12360086569464816,2],"GBP":[0.1233413966785401,2],"GEL":[0.4080766535022831,2],"GGP":[0.12360086569464816,2],"GHS":[1.458919329358798,2],"GIP":[0.12360086569464816,2],"GMD":[7.871129961205036,2],"GNF":[1249.5081566030162,2],"GTQ":[1.1269565794773828,2],"GYD":[30.22768883495277,2],"HKD":[1.133746802411281,2],"HNL":[3.561675471657249,2],"HRK":[1.0724287596540356,2],"HTG":[17.26567190719986,2],"HUF":[56.493732491006575,2],"IDR":[2146.0134248499503,2],"ILS":[0.4849678242746445,2],"IMP":[0.12360086569464816,2],"INR":[11.424456970960701,2],"IQD":[210.86638043857246,2],"IRR":[6110.33558135237,2],"ISK":[20.0226035842061,2],"JEP":[0.12360086569464816,2],"JMD":[21.92874704392692,2],"JOD":[0.10251747639950476,2],"JPY":[20.559400950018517,2],"KES":[17.39494361714057,2],"KGS":[11.842346711305028,2],"KHR":[594.3998018574334,2],"KMF":[70.51804421061361,2],"KPW":[130.0071789277532,2],"KRW":[198.63218920463555,2],"KWD":[0.04450142978684357,3],"KYD":[0.12040544990374284,2],"KZT":[68.34664690085562,2],"LAK":[2274.1531202039732,2],"LBP":[217.5014460303734,2],"LKR":[52.30106071674718,2],"LRD":[22.2384344998895,2],"LSL":[2.4853023839944806,2],"LTL":[0.4265303008087996,2],"LVL":[0.08737779415429558,3],"LYD":[0.7141771391125817,2],"MAD":[1.545604778675494,2],"MDL":[2.792045201468928,2],"MGA":[608.2497958516019,2],"MKD":[8.781747943448009,2],"MMK":[303.4039118979439,2],"MNT":[465.30515451372787,2],"MOP":[1.1680102488124056,2],"MRO":[51.56947421831218,2],"MUR":[6.530195510829804,2],"MVR":[2.24047933231683,2],"MWK":[148.29226085570062,2],"MXN":[2.861703014414423,2],"MYR":[0.6509744194327332,2],"MZN":[9.220372834605673,2],"NAD":[2.4852968269974305,2],"NGN":[61.76817091727071,2],"NIO":[5.192577875257956,2],"NOK":[1.420415181772936,2],"NPR":[18.384316928935554,2],"NZD":[0.2354589416998341,2],"OMR":[0.05561214668363403,3],"PAB":[0.14448092589259975,2],"PEN":[0.5610881398151857,2],"PGK":[0.5090816292944367,2],"PHP":[8.199403862454918,2],"PKR":[33.3924898467252,2],"PLN":[0.6690095821152467,2],"PYG":[999.2836496475794,2],"QAR":[0.5259530997998199,2],"RON":[0.7004066154482523,2],"RSD":[16.71751219226526,2],"RUB":[8.73575795088726,2],"RWF":[149.58034242215825,2],"SAR":[0.5429901403198749,2],"SBD":[1.1845374704748908,2],"SCR":[1.8797250682833824,2],"SDG":[83.20456175312714,2],"SEK":[1.512612744702009,2],"SGD":[0.2014640834894636,2],"SHP":[0.19896927678818105,2],"SLL":[2079.39203844758,2],"SOS":[81.97198461310263,2],"SRD":[3.8680734703403834,2],"STD":[2989.872585894432,2],"SVC":[1.2642005853655203,2],"SYP":[362.94091700995375,2],"SZL":[2.46968280518351,2],"THB":[5.2413107445677865,2],"TJS":[1.4592611559209303,2],"TMT":[0.5055832859207496,2],"TND":[0.459011518514988,2],"TOP":[0.34098702811655274,2],"TRY":[2.634094399701119,2],"TTD":[0.9815772723950188,2],"TWD":[4.463650186180773,2],"TZS":[336.86287269105,2],"UAH":[5.335857349890905,2],"UGX":[550.9198693849216,2],"USD":[0.14445242847183007,2],"UYU":[5.894113131055791,2],"UZS":[1582.0836329480908,2],"VND":[3402.1424174276544,2],"VUV":[17.137687140781107,2],"WST":[0.3927833701591253,2],"XAF":[93.48871167292826,2],"XAG":[0.007326259418575674,4],"XAU":[0.00008378241706288768,6],"XCD":[0.39038972930157523,2],"XDR":[0.11094074403060965,2],"XOF":[93.49009522270663,2],"XPF":[17.14659087492639,2],"YER":[36.1491943992879,2],"ZAR":[2.4704895671654996,2],"ZMK":[1300.2465863295877,2],"ZMW":[2.2394055495022283,2],"ZWL":[46.513606877225556,2]},"symbols":{"AED":"","AFN":"","ALL":"","AMD":"","ANG":"","AOA":"","ARS":"$","AUD":"A$","AWG":"","AZN":"","BAM":"","BBD":"","BDT":"","BGN":"","BHD":"","BIF":"","BMD":"","BND":"","BOB":"","BRL":"R$","BSD":"","BTC":"","BTN":"","BWP":"","BYN":"","BYR":"","BZD":"","CAD":"C$","CDF":"","CHF":"Fr","CLF":"","CLP":"","COP":"","CRC":"","CUC":"","CUP":"","CVE":"","CZK":"","DJF":"","DKK":"Kr","DOP":"","DZD":"","EGP":"","ERN":"","ETB":"","EUR":"€","FJD":"","FKP":"","GBP":"","GEL":"","GGP":"","GHS":"","GIP":"","GMD":"","GNF":"","GTQ":"","GYD":"","HKD":"","HNL":"","HRK":"","HTG":"","HUF":"","IDR":"","ILS":"","IMP":"","INR":"₹","IQD":"","IRR":"","ISK":"","JEP":"","JMD":"","JOD":"","JPY":"¥","KES":"","KGS":"","KHR":"","KMF":"","KPW":"","KRW":"₩","KWD":"","KYD":"","KZT":"","LAK":"","LBP":"","LKR":"","LRD":"","LSL":"","LTL":"","LVL":"","LYD":"","MAD":"","MDL":"","MGA":"","MKD":"","MMK":"","MNT":"","MOP":"","MRO":"","MUR":"","MVR":"","MWK":"","MXN":"M$","MYR":"","MZN":"","NAD":"","NGN":"","NIO":"","NOK":"","NPR":"","NZD":"","OMR":"","PAB":"","PEN":"","PGK":"","PHP":"","PKR":"","PLN":"","PYG":"","QAR":"","RON":"","RSD":"","RUB":"","RWF":"","SAR":"SR","SBD":"","SCR":"","SDG":"","SEK":"kr","SGD":"S$","SHP":"","SLL":"","SOS":"","SRD":"","STD":"","SVC":"","SYP":"","SZL":"","THB":"","TJS":"","TMT":"","TND":"","TOP":"","TRY":"₺","TTD":"","TWD":"","TZS":"","UAH":"","UGX":"","USD":"$","UYU":"","UZS":"","VEF":"","VND":"","VUV":"","WST":"","XAF":"","XAG":"","XAU":"","XCD":"","XDR":"","XOF":"","XPF":"","YER":"","ZAR":"","ZMK":"","ZMW":"","ZWL":""}}`;

    let data: Data;

    let recursionBreak: number = 0;

    /**
     * Initialize the CurrencyHelper, this function call should happen <b>ONCE</b>
     *
     * @param fetchNew If we should fetch current active rates
     * @param onFetch callback when the response was received, only will happen if <code>fetchNew</code> is true
     */
    export function initialize(fetchNew: boolean = true, onFetch: (data: Data) => void = null): void {
        // shouldn't be necessary, but to prevent getting stuck, we kill it after 5 calls
        if (recursionBreak > 5) {
            return;
        } else {
            recursionBreak ++;
        }

        if (fetchNew) {
            try {
                fetch('https://penguinivogel.github.io/currency-repository/rates.json')
                    .then(r => r.json().then(_pdata => {
                        data = _pdata;

                        console.debug('[CurrencyHelper] Fetched current rates.', _pdata);

                        if (typeof onFetch == 'function') {
                            onFetch(_pdata);
                        }
                    }));
            } catch (_e) {
                console.warn('[CurrencyHelper] Failed to fetch json, using STATIC.', _e);
                initialize(false, null);
            }
        } else {
            try {
                data = JSON.parse(raw);
            } catch (e) {
                console.warn('[CurrencyHelper] Error reading STATIC.', e);
                initialize(true);
            }

            console.debug(`[CurrencyHelper] Read from STATIC.`, data);
        }
    }

    export function getData(): Data {
        return data;
    }

}
